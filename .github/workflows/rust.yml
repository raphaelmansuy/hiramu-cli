name: Rust

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    - name: Build
      run: cargo build --verbose


    - name: Get version
      run: echo "VERSION=$(grep '^version' Cargo.toml | cut -d '"' -f 2)" >> $GITHUB_ENV

    - name: Check if release exists
      id: check_release
      run: |
        echo "::set-output name=exists::$(gh release view v${{ env.VERSION }} > /dev/null 2>&1 && echo true || echo false)"
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          

    - name: Create release
      if: github.event_name == 'push' && github.ref == 'refs/heads/master' && steps.check_release.outputs.exists == 'false'
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ env.VERSION }}
        release_name: Release v${{ env.VERSION }}
        draft: false
        prerelease: false

    - name: "Update Homebrew formula"
      if: github.event_name == 'push' && github.ref == 'refs/heads/master'
      env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
            # Install Homebrew
            /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
            
            # Add Homebrew to PATH
            echo 'eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"' >> /home/runner/.bashrc
            eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
            
            # Check if Homebrew is installed
            if ! command -v brew &> /dev/null
            then
              echo "Homebrew could not be installed"
              exit 1
            fi
            
            # Clone the Homebrew tap repository
            git clone https://github.com/raphaelmansuy/homebrew-tap.git
            cd homebrew-tap
            
            # Extract the version number from the GitHub ref
            version="${GITHUB_REF#refs/tags/v}"
            
            # Update the Homebrew formula
            brew bump-formula-pr --version="$version" --url="https://github.com/raphaelmansuy/hiramu-cli/archive/v$version.tar.gz" hiramu-cli
            
            # Push the changes to the Homebrew tap repository
            git push origin master

